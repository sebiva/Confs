#!/bin/bash

#Takes the file to install (to $HOME) and its path
function installfile {
if [ "$#" == 2 ]
then
  if [ -e "$1/$2" ]
  then
    #if { [ ! -e "$HOME/$2" ] || [ -L "$HOME/$2" ]; } && [ -e "$1/$2" ]
    if [ -L "$HOME/$2" ]
    then
      rm "$HOME/$2"
      ln -s "$1/$2" "$HOME/$2"
      echo "updated $2"
    else
      if [ ! -e "$HOME/$2" ]
      then
        ln -s "$1/$2" "$HOME/$2"
        echo "installed $2"
      else
        echo "Already exists: $HOME/$2"
      fi
    fi
  else
    echo "Source $1/$2 not found"
  fi
fi
}
# Takes the path relative to $SCRIPTPATH and the filename
function installfileinfolder {
if [ "$#" == 2 ]
then
    if [ ! -d "$HOME/$1" ] && [ -e "$SCRIPTPATH/$1" ]
    then
        mkdir -p "$1"
    fi
    installfile "$1" "$2"
fi
}
# Takes the path relative to $SCRIPTPATH
function installallinfolder {
if [ "$#" == 1 ]
then
    pth="$1/*"
    for i in $pth
    do
        if [ -f "$i" ]
        then
            file=$(basename "$i")
            dir=$(dirname "$i")
            installfileinfolder "$dir" "$file"
        fi
    done
fi

}


# Tmux Plugin Manager
if [ ! -d "$HOME/.tmux/plugins/tpm" ] # || [ ! -d "$HOME/.tmux/plugins/tmux-resurrect" ]
then
    echo "Installing tmux plugin manager"
    git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
    #git clone https://github.com/tmux-plugins/tmux-resurrect ~/.tmux/plugins/tmux-resurrect
    tmux source-file ~/.tmux.conf
fi

# Install dotfiles directly to $HOME
SCRIPTPATH=$( cd $(dirname $0) ; pwd -P )

echo "Installing config files from $SCRIPTPATH to $HOME"
shopt -s dotglob # List . files too
echo $SCRIPTPATH/files
DIRECTFILES=$(ls -A $SCRIPTPATH/files/direct)


for f in $DIRECTFILES
do
  installfile "$SCRIPTPATH/files/direct" "$f"
done

### Vim
# colors
cp "$SCRIPTPATH/files/.vim/colors/BenokaiPrime.vim" "$HOME/"
# vundle
git "clone https://github.com/gmarik/Vundle.vim.git" "$HOME/.vim/bundle/Vundle.vim"
vim +PluginInstall +qall
# Vim-latex
mkdir tmp
git clone https://github.com/vim-latex/vim-latex tmp/
cd tmp; make; cd ..
rm -rf tmp
echo "Vim installed"

### ZSH
mv "$HOME/.zshrc" "$HOME/.bakzshrc"
# oh-my-zsh
mkdir tmp
git clone https://github.com/robbyrussell/oh-my-zsh.git tmp/
tmp/tools/install.sh
rm -rf tmp

# stub
cp "files/.zshrc-stub" "$HOME/.zshrc"
echo "Zsh installed"

## Install scripts

if [ ! -d "$HOME/Dropbox" ]
then
  mkdir "$HOME/Documents/Scripts"
  mkdir "$HOME/Documents/Scripts/ctrl"
  mkdir "$HOME/Documents/Scripts/internet"
  installallinfolder "$HOME/Documents/Scripts"
  installallinfolder "$HOME/Documents/Scripts/ctrl"
  installallinfolder "$HOME/Documents/Scripts/internet"
  echo "Scripts installed"
fi
